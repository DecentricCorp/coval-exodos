/*
exodos - v0.0.0 - 2017-01-06
Transition tools to assist in exodos from legacy chain
Lovingly coded by Shannon Code  - http://cov.al 
*/
function init(){footerCallbackCnt=0,table=$("#example-table").DataTable({ajax:"utils/data/rich.json",deferRender:!1,columns:[{className:"details-control",orderable:!0,data:"txs",defaultContent:""},{data:"address"},{data:"balance",className:"sum",render:$.fn.dataTable.render.number(",",".",7,"")},{data:"lastActivity"},{data:"txCount"}],footerCallback:function(row,data,start,end,display){verbose&&console.log("in footerCallback");var api=this.api();api.columns(".sum",{search:"applied",page:"all"}).every(function(){var sum=api.cells(null,this.index(),{search:"applied",page:"all"}).render("display").reduce(function(a,b){var x=parseFloat(a)||0,y=parseFloat(b)||0;return x+y},0);verbose&&console.log(this.index()+" "+sum),$(this.footer()).html(sum),0===footerCallbackCnt?footerCallbackCnt++:footerCallbackCnt=0})}}),$.fn.dataTable.ext.search.push(function(settings,data,dataIndex){var min=parseInt($("#min").val(),10),max=parseInt($("#max").val(),10),age=parseFloat(data[4])||0;return isNaN(min)&&isNaN(max)||isNaN(min)&&max>=age||age>=min&&isNaN(max)||age>=min&&max>=age?!0:!1}),loginCheck()}function loginCheck(cb){if(!cb)var cb=function(bool){};me.data.identity(function(identity){var loggedIn=""!=identity.email&&""!=identity.name;return verbose&&console.log("Logged in",loggedIn,identity),loggedIn?($(".loginStatus").text(identity.name.replace("::"," ")+" Logout"),enableKeysView()):disableKeysView(),cb(loggedIn)})}function enableKeysView(){$("body").off("click.keys"),$("body").on("click.keys",".viewKeys",function(){renderKeysTemplate()})}function disableKeysView(){$("body").off("click.keys"),$("body").on("click.keys",".viewKeys",function(){popLoginModalSelection()})}function showExplorer(){jQuery.get("/explorer",function(resp){templates[name]=Handlebars.compile(resp),display_Pagetemplate(name,function(){init()})})}function display_Pagetemplate(tmpl,cb){if(console.log("display"),void 0!==templates[tmpl]){var template=templates[tmpl],html=template();return $(".pageContent").html(html),cb()}}function getRow(address,cb){var filtered=table.rows()[0].filter(function(a){var data=table.rows(a).data()[0].address;return data==address});return cb(table.rows(filtered[0]).data()[0])}function signBalance(key,cb){var hd=bitcore.HDPrivateKey(key),address=hd.privateKey.toAddress().toString();getRow(address,function(details){var msg=details.address+details.balance+details.lastActivity,payload=generatePayload(msg,key);return payload.coval.swap=details,payload=deserializePayload(payload),cb(payload)})}function deserializePayload(payload){return"string"==typeof payload&&(payload=JSON.parse(payload)),payload.verify=getVerifyFunction(payload),payload.serialize=function(){return JSON.stringify(payload)},payload}function getVerifyFunction(payload){var cb=function(result){return result};return function(){return newtables.privkey.verifyMessage(payload.coval.toSign,payload.coval.covalAddress,payload.coval.signature,cb)}}function generateMnemonicSeed(){var m=new _Mnemonic(128),p=m.toWords().toString().replace(/,/gi," "),h=m.toHex();return{phrase:p,seed:h}}function generateSeedFromFreeWallet(){return CryptoJS.AES.decrypt(localStorage.getItem("wallet"),String(0)).toString(CryptoJS.enc.Utf8)}function generateAddressFromSeed(seed,index,cb){var pk=bitcore.HDPrivateKey.fromSeed(seed,bitcore.Networks.mainnet),d=pk.derive("m/0'/0/"+index),returnVal=d.privateKey.toAddress().toString();return cb(returnVal)}function performSignturesOverKeys(cb){var _keys,payloads=[],totalBalance=0;if(!cb)var cb=function(){};loginCheck(function(loggedIn){return loggedIn?localStorage.address?me.data.privkey.allRecordsArray(function(items){return items.length>0?(_keys=items.filter(function(item){return"coval"===item.key.network.name}),void _keys.forEach(function(item){signBalance(item.key.xprivkey,function(_payload){var balance=_payload.coval.swap.balance,rounded=Math.round(balance);if(totalBalance+=rounded,console.log("Processed",_payload.coval.covalAddress,"with a balance of",balance,"rounded to",rounded,"for a total of",totalBalance),payloads[payloads.length]=_payload,payloads.length===_keys.length){console.log("Complete");var bonus=Math.round(.15*totalBalance),seed=generateSeedFromFreeWallet();generateAddressFromSeed(seed,0,function(xcpAddress){var swapRequest=packageSwapRequest(xcpAddress,payloads,totalBalance,bonus);return cb(swapRequest)})}})})):cb(payloads)}):console.log("No xcp address"):(console.log("Not logged in"),popLoginModalSelection()),cb(payloads)})}function packageSwapRequest(xcpAddress,payloads,totalBalance,bonus){return{CounterpartyAddress:xcpAddress,SwapSignatures:payloads,A_TotalOfBalances:totalBalance,B_BonusAmount:bonus,C_TotalSwapRequested:totalBalance+bonus,PassedSignatureChecks:!0}}var table;$(document).ready(function(){init(),verbose=!1;Mnemonic}),$("#min, #max").keyup(function(){table.draw()}),$("body").on("keyup",".customSearch",function(){$("input[type='search']").val($(".customSearch").val()),$("input[type='search']").trigger("keyup")}),$(".dataTables_filter").hide(),$(function(){$("#nav li a").click(function(){$("#nav li").removeClass(),$($(this).attr("href")).addClass("active")})}),$("body").on("click",".loginStatus",function(){popLoginModalSelection()}),$("body").on("click","#example-table tbody",function(){var tr=$(this).closest("tr"),row=table.row(tr);row.child.isShown()?(row.child.hide(),tr.removeClass("shown")):(row.child(format(row.data())).show(),tr.addClass("shown"))});var templates={};